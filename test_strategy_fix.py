#!/usr/bin/env python3
"""
æµ‹è¯•ç­–ç•¥ä¿®å¤æ•ˆæœ
éªŒè¯æ—¶é—´æ¡†æ¶ä»15mæ”¹ä¸º5mï¼Œä»¥åŠæ—¥å¿—è¾“å‡ºçš„æ”¹è¿›
"""

import sys
import os
sys.path.insert(0, '.')

def test_strategy_fix():
    """æµ‹è¯•ç­–ç•¥ä¿®å¤æ•ˆæœ"""
    print("ğŸ§ª æµ‹è¯•ç­–ç•¥ä¿®å¤æ•ˆæœ...")
    print("=" * 50)

    try:
        # å¯¼å…¥ç­–ç•¥æ¨¡å—
        from src.strategy_engine.dual_ema_strategy import DualEMAStrategy
        import logging

        # è®¾ç½®æ—¥å¿—
        logging.basicConfig(level=logging.INFO)

        print("âœ… ç­–ç•¥æ¨¡å—å¯¼å…¥æˆåŠŸ")

        # åˆ›å»ºç­–ç•¥å®ä¾‹
        strategy = DualEMAStrategy()
        print("âœ… ç­–ç•¥å®ä¾‹åˆ›å»ºæˆåŠŸ")

        # æ¨¡æ‹Ÿ5åˆ†é’Ÿæ•°æ®
        mock_data = {
            "historical_analysis": {
                "5m": {
                    "ohlcv": [
                        # æ¨¡æ‹Ÿ25æ ¹Kçº¿æ•°æ® (éœ€è¦è¶³å¤Ÿçš„EMAè®¡ç®—æ•°æ®)
                        [1609459200, 50000, 50100, 49900, 50050, 100],  # å¼€é«˜ä½æ”¶é‡
                        [1609459500, 50050, 50200, 50000, 50150, 120],
                        [1609459800, 50150, 50300, 50100, 50250, 90],
                        [1609460100, 50250, 50400, 50200, 50350, 110],
                        [1609460400, 50350, 50500, 50300, 50450, 130],
                        [1609460700, 50450, 50600, 50400, 50550, 140],
                        [1609461000, 50550, 50700, 50500, 50650, 150],
                        [1609461300, 50650, 50800, 50600, 50750, 160],
                        [1609461600, 50750, 50900, 50700, 50850, 170],
                        [1609461900, 50850, 51000, 50800, 50950, 180],
                        [1609462200, 50950, 51100, 50900, 51050, 190],
                        [1609462500, 51050, 51200, 51000, 51150, 200],
                        [1609462800, 51150, 51300, 51100, 51250, 210],
                        [1609463100, 51250, 51400, 51200, 51350, 220],
                        [1609463400, 51350, 51500, 51300, 51450, 230],
                        [1609463700, 51450, 51600, 51400, 51550, 240],
                        [1609464000, 51550, 51700, 51500, 51650, 250],
                        [1609464300, 51650, 51800, 51600, 51750, 260],
                        [1609464600, 51750, 51900, 51700, 51850, 270],
                        [1609464900, 51850, 52000, 51800, 51950, 280],
                        [1609465200, 51950, 52100, 51900, 52050, 290],
                        [1609465500, 52050, 52200, 52000, 52150, 300],
                        [1609465800, 52150, 52300, 52100, 52250, 310],
                        [1609466100, 52250, 52400, 52200, 52350, 320],
                        [1609466400, 52350, 52500, 52300, 52450, 330],
                        [1609466700, 52450, 52600, 52400, 52550, 340],
                        [1609467000, 52550, 52700, 52500, 52650, 350],
                    ]
                }
            }
        }

        print("\nğŸ“Š æµ‹è¯•åœºæ™¯1: æ­£å¸¸5mæ•°æ®")
        signal = strategy.generate_signal(mock_data, "BTC-USDT")
        print(f"ğŸ“ˆ ä¿¡å·ç»“æœ: {signal['signal']}")
        print(f"ğŸ“ ç†ç”±: {signal['reasoning']}")

        print("\nğŸ“Š æµ‹è¯•åœºæ™¯2: æ— 5mæ•°æ®")
        empty_data = {
            "historical_analysis": {
                "15m": {  # åªæœ‰15mæ•°æ®ï¼Œæ²¡æœ‰5m
                    "ohlcv": mock_data["historical_analysis"]["5m"]["ohlcv"]
                }
            }
        }
        signal = strategy.generate_signal(empty_data, "ETH-USDT")
        print(f"ğŸ“ˆ ä¿¡å·ç»“æœ: {signal['signal']}")
        print(f"ğŸ“ ç†ç”±: {signal['reasoning']}")

        print("\nğŸ“Š æµ‹è¯•åœºæ™¯3: æ•°æ®ä¸è¶³")
        insufficient_data = {
            "historical_analysis": {
                "5m": {
                    "ohlcv": mock_data["historical_analysis"]["5m"]["ohlcv"][:10]  # åªæœ‰10æ ¹Kçº¿ï¼Œä¸å¤Ÿ21+1
                }
            }
        }
        signal = strategy.generate_signal(insufficient_data, "SOL-USDT")
        print(f"ğŸ“ˆ ä¿¡å·ç»“æœ: {signal['signal']}")
        print(f"ğŸ“ ç†ç”±: {signal['reasoning']}")

        print("\n" + "=" * 50)
        print("âœ… ç­–ç•¥ä¿®å¤æµ‹è¯•å®Œæˆ")
        print("\nğŸ¯ ä¿®å¤å†…å®¹éªŒè¯:")
        print("1. âœ… æ—¶é—´æ¡†æ¶ä»15mæ”¹ä¸º5m")
        print("2. âœ… å˜é‡åä»timeframe_15mæ”¹ä¸ºtimeframe_data")
        print("3. âœ… é”™è¯¯ä¿¡æ¯æ›´æ–°ä¸º5m")
        print("4. âœ… æ—¥å¿—è¾“å‡ºåŒ…å«[STRATEGY]å‰ç¼€")
        print("5. âœ… æ˜¾ç¤ºå½“å‰ä»·æ ¼ã€EMAå€¼å’Œå·®å€¼")

        return True

    except Exception as e:
        print(f"âŒ æµ‹è¯•å¤±è´¥: {e}")
        import traceback
        traceback.print_exc()
        return False

if __name__ == "__main__":
    success = test_strategy_fix()
    sys.exit(0 if success else 1)
