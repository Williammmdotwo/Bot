#!/usr/bin/env python3
"""
æµ‹è¯•ç­–ç•¥å¿ƒè·³æ—¥å¿—è¾“å‡ºæ•ˆæœ
éªŒè¯æ–°å¢çš„å¿ƒè·³å’Œä¿¡å·æ—¥å¿—æ˜¯å¦æ­£å¸¸å·¥ä½œ
"""

import sys
import os
sys.path.insert(0, '.')

def test_strategy_heartbeat():
    """æµ‹è¯•ç­–ç•¥å¿ƒè·³æ—¥å¿—"""
    print("ğŸ§ª æµ‹è¯•ç­–ç•¥å¿ƒè·³æ—¥å¿—è¾“å‡º...")
    print("=" * 50)

    try:
        # å¯¼å…¥ç­–ç•¥æ¨¡å—
        from src.strategy_engine.dual_ema_strategy import DualEMAStrategy
        import logging

        # è®¾ç½®æ—¥å¿—
        logging.basicConfig(level=logging.INFO)

        print("âœ… ç­–ç•¥æ¨¡å—å¯¼å…¥æˆåŠŸ")

        # åˆ›å»ºç­–ç•¥å®ä¾‹
        strategy = DualEMAStrategy()
        print("âœ… ç­–ç•¥å®ä¾‹åˆ›å»ºæˆåŠŸ")

        # æ¨¡æ‹Ÿ5åˆ†é’Ÿæ•°æ® - æµ‹è¯•HOLDä¿¡å·
        print("\nğŸ“Š æµ‹è¯•åœºæ™¯1: HOLDä¿¡å·ï¼ˆå¿ƒè·³æ—¥å¿—ï¼‰")
        mock_data_hold = {
            "historical_analysis": {
                "5m": {
                    "ohlcv": [
                        [1609459200, 50000, 50100, 49900, 50050, 100],
                        [1609459500, 50050, 50200, 50000, 50150, 120],
                        [1609459800, 50150, 50300, 50100, 50250, 90],
                        [1609460100, 50250, 50400, 50200, 50350, 110],
                        [1609460400, 50350, 50500, 50300, 50450, 130],
                        [1609460700, 50450, 50600, 50400, 50550, 140],
                        [1609461000, 50550, 50700, 50500, 50650, 150],
                        [1609461300, 50650, 50800, 50600, 50750, 160],
                        [1609461600, 50750, 50900, 50700, 50850, 170],
                        [1609461900, 50850, 51000, 50800, 50950, 180],
                        [1609462200, 50950, 51100, 50900, 51050, 190],
                        [1609462500, 51050, 51200, 51000, 51150, 200],
                        [1609462800, 51150, 51300, 51100, 51250, 210],
                        [1609463100, 51250, 51400, 51200, 51350, 220],
                        [1609463400, 51350, 51500, 51300, 51450, 230],
                        [1609463700, 51450, 51600, 51400, 51550, 240],
                        [1609464000, 51550, 51700, 51500, 51650, 250],
                        [1609464300, 51650, 51800, 51600, 51750, 260],
                        [1609464600, 51750, 51900, 51700, 51850, 270],
                        [1609464900, 51850, 52000, 51800, 51950, 280],
                        [1609465200, 51950, 52100, 51900, 52050, 300],
                        [1609465500, 52050, 52200, 52000, 52150, 310],
                        [1609465800, 52150, 52300, 52100, 52250, 320],
                        [1609466100, 52250, 52400, 52200, 52350, 330],
                        [1609466400, 52350, 52500, 52300, 52450, 340],
                        [1609466700, 52550, 52700, 52500, 52650, 350],
                        [1609467000, 52650, 52800, 52600, 52750, 350]
                    ]
                }
            }
        }

        signal_hold = strategy.generate_signal(mock_data_hold, "BTC-USDT")
        print(f"ğŸ“ˆ HOLDä¿¡å·ç»“æœ: {signal_hold['signal']}")
        print(f"ğŸ“ å¿ƒè·³æ—¥å¿—æ£€æŸ¥: æŸ¥æ‰¾ [HEARTBEAT] æ ‡è®°")

        # æ¨¡æ‹Ÿ5åˆ†é’Ÿæ•°æ® - æµ‹è¯•BUYä¿¡å·ï¼ˆé‡‘å‰ï¼‰
        print("\nğŸ“Š æµ‹è¯•åœºæ™¯2: BUYä¿¡å·ï¼ˆäº¤æ˜“ä¿¡å·ï¼‰")
        mock_data_buy = {
            "historical_analysis": {
                "5m": {
                    "ohlcv": [
                        # åˆ›å»ºä¸Šæ¶¨è¶‹åŠ¿ï¼Œå¿«çº¿ä»ä¸‹å¾€ä¸Šç©¿è¿‡æ…¢çº¿
                        [1609459200, 48000, 48100, 47900, 48050, 100],
                        [1609459500, 48050, 48200, 48000, 48150, 120],
                        [1609459800, 48150, 48300, 48100, 48250, 90],
                        [1609460100, 48250, 48400, 48200, 48350, 110],
                        [1609460400, 48350, 48500, 48300, 48450, 130],
                        [1609460700, 48450, 48600, 48400, 48550, 140],
                        [1609461000, 48550, 48700, 48500, 48650, 150],
                        [1609461300, 48650, 48800, 48600, 48750, 160],
                        [1609461600, 48750, 48900, 48700, 48850, 170],
                        [1609461900, 48850, 49000, 48800, 48950, 180],
                        [1609462200, 48950, 49100, 48900, 49050, 190],
                        [1609462500, 49050, 49200, 49000, 49150, 200],
                        [1609462800, 49150, 49300, 49100, 49250, 210],
                        [1609463100, 49250, 49400, 49200, 49350, 220],
                        [1609463400, 49350, 49500, 49300, 49450, 230],
                        [1609463700, 49450, 49600, 49400, 49550, 240],
                        [1609464000, 49550, 49700, 49500, 49650, 250],
                        [1609464300, 49650, 49800, 49600, 49750, 260],
                        [1609464600, 49750, 49900, 49700, 49850, 270],
                        [1609464900, 49850, 50000, 49800, 49950, 280],
                        [1609465200, 49950, 50100, 49900, 50050, 300],
                        [1609465500, 50050, 50200, 50000, 50150, 310],
                        [1609465800, 50150, 50300, 50100, 50250, 320],
                        [1609466100, 50250, 50400, 50200, 50350, 330],
                        [1609466400, 50350, 50500, 50300, 50450, 340],
                        [1609466700, 50450, 50600, 50400, 50550, 350],
                        [1609467000, 50550, 50700, 50500, 50650, 350]
                    ]
                }
            }
        }

        signal_buy = strategy.generate_signal(mock_data_buy, "BTC-USDT")
        print(f"ğŸ“ˆ BUYä¿¡å·ç»“æœ: {signal_buy['signal']}")
        print(f"ğŸ“ äº¤æ˜“æ—¥å¿—æ£€æŸ¥: æŸ¥æ‰¾ [SIGNAL] æ ‡è®°")

        print("\n" + "=" * 50)
        print("âœ… ç­–ç•¥å¿ƒè·³æ—¥å¿—æµ‹è¯•å®Œæˆ")
        print("\nğŸ¯ é¢„æœŸæ—¥å¿—è¾“å‡º:")
        print("1. HOLDä¿¡å·æ—¶åº”è¯¥çœ‹åˆ°: [HEARTBEAT] BTC-USDT æ­£åœ¨ç›‘æ§ | ä»·æ ¼: xxx | å¿«çº¿: xxx | æ…¢çº¿: xxx | çŠ¶æ€: ç­‰å¾…äº¤å‰")
        print("2. BUY/SELLä¿¡å·æ—¶åº”è¯¥çœ‹åˆ°: ğŸš€ [SIGNAL] è§¦å‘äº¤æ˜“ï¼BUY @ xxx")
        print("3. ç­–ç•¥åˆ†ææ—¥å¿—: [STRATEGY] BTC-USDT 5måˆ†æ: å½“å‰ä»·æ ¼=xxx | å¿«çº¿EMA_9=xxx | æ…¢çº¿EMA_21=xxx | å·®å€¼=xxx")

        return True

    except Exception as e:
        print(f"âŒ æµ‹è¯•å¤±è´¥: {e}")
        import traceback
        traceback.print_exc()
        return False

if __name__ == "__main__":
    success = test_strategy_heartbeat()
    sys.exit(0 if success else 1)
