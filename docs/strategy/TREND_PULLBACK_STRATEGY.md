# 趋势回调策略 (Trend Pullback Strategy)

## 📋 策略概述

趋势回调策略是一个基于趋势跟踪和均值回归结合的交易策略。该策略在明确的大趋势下，等待价格回调到超卖/超买区域后入场，利用"不死鸟"仓位管理模型严格控制风险。

### 核心理念

1. **顺势而为** - 只在明确的大趋势方向上交易
2. **回调买入** - 在牛市中等待价格回调到超卖区域买入
3. **严格止损** - 每单最多只亏本金的 2%
4. **理性杠杆** - 杠杆率控制在 2x-3x 之间

---

## 🎯 策略规则

### 1. 大趋势判断（过滤器）

使用 **EMA 144**（144周期指数移动平均线）判断大趋势方向：

- **牛市** (Bullish): 当前价格 > EMA 144
  - 只做多（买入）
  - 等待回调到超卖区域

- **熊市** (Bearish): 当前价格 < EMA 144
  - 如果允许做空，只做空
  - 等待反弹到超买区域

- **中性** (Neutral): 价格在 EMA 144 附近
  - 不交易，等待明确趋势

### 2. 入场信号（扳机）

在牛市背景下，等待以下条件触发：

- **RSI < 30** (超卖)
  - 说明价格回调到位
  - 发出 **BUY** 信号

在熊市背景下（如果允许做空）：

- **RSI > 70** (超买)
  - 说明价格反弹到位
  - 发出 **SELL** 信号

### 3. 出场信号（止盈/止损）

#### 止盈条件

1. **RSI > 70** (超买)
   - 价格进入超买区域
   - 平仓止盈

2. **价格触碰布林带上轨**
   - 价格短期内涨幅过大
   - 平仓止盈

#### 止损条件

1. **百分比止损**: -3%
   - 价格从入场价下跌 3%
   - 强制止损离场

2. **趋势止损**: 跌破 EMA 144
   - 大趋势发生反转
   - 强制止损离场

---

## 🦅 "不死鸟"仓位管理模型

### 核心原理

**每单最多只亏本金的 2%**，确保即使连续亏损50次，本金仍有约 37% 剩余。

### 计算公式

```python
# 1. 计算允许的最大亏损金额
max_risk_amount = capital × 2%

# 2. 计算每单位的止损金额
risk_per_unit = current_price - stop_loss_price

# 3. 计算应该买入的数量（核心公式）
position_size = max_risk_amount / risk_per_unit

# 4. 计算仓位价值
position_value = position_size × current_price

# 5. 计算实际杠杆率
leverage = position_value / capital

# 6. 杠杆率调整（确保在 2x-3x 之间）
if leverage > 3x:
    降低仓位到 3x
elif leverage < 2x:
    可选：提高仓位到 2x
```

### 计算示例

#### 场景1：正常情况
- SOL 当前价格: $150
- 止损价格: $145（-3.3%）
- 本金: $100

**计算过程**:
```
最大风险 = $100 × 2% = $2
风险/单位 = $150 - $145 = $5
仓位数量 = $2 / $5 = 0.4 SOL
仓位价值 = 0.4 × $150 = $60
杠杆率 = $60 / $100 = 0.6x
实际风险 = 0.4 × $5 = $2 (2%)
```

#### 场景2：小止损距离
- SOL 当前价格: $150
- 止损价格: $149（-0.67%）
- 本金: $100

**计算过程**:
```
最大风险 = $100 × 2% = $2
风险/单位 = $150 - $149 = $1
仓位数量 = $2 / $1 = 2 SOL
仓位价值 = 2 × $150 = $300
杠杆率 = $300 / $100 = 3x（被限制）
实际风险 = 2 × $1 = $2 (2%)
```

### 杠杆率自动调整

- **杠杆 > 3x**: 自动降低仓位，确保杠杆不超过 3x
- **杠杆 < 2x**: 记录日志（可选：提高仓位到 2x）

### 优势

✅ **风险可控**: 每单最大亏损固定为 2%
✅ **长期生存**: 连续亏损50次仍有 37% 本金
✅ **理性杠杆**: 避免高杠杆爆仓风险
✅ **精确仓位**: 基于止损距离动态调整

---

## ⚙️ 配置参数

### 策略参数

```json
{
  "strategy": {
    "type": "trend_pullback",
    "enabled": true,
    "ema_period": 144,              // EMA 周期
    "rsi_period": 14,               // RSI 周期
    "rsi_oversold": 30,             // 超卖阈值（买入）
    "rsi_overbought": 70,           // 超买阈值（卖出）
    "stop_loss_pct": 0.03,            // 止损百分比（3%）
    "take_profit_pct": 0.06,          // 止盈百分比（6%）
    "use_bollinger_exit": true,        // 使用布林带止盈
    "bollinger_period": 20,           // 布林带周期
    "bollinger_std_dev": 2,           // 布林带标准差
    "only_long": true,                // 只做多模式
    "max_leverage": 3.0,             // 最大杠杆
    "min_leverage": 2.0              // 最小杠杆
  }
}
```

### 交易参数

```json
{
  "trading": {
    "capital": 100.0,                // 本金
    "max_risk_pct": 0.02,             // 每单最大风险（2%）
    "position_size_pct": 0.5,          // 仓位大小百分比（备用）
    "trading_symbol": "SOL-USDT-SWAP",  // 交易对
    "use_demo": true,                  // 模拟交易
    "signal_interval_seconds": 60        // 信号检查间隔（秒）
  }
}
```

### 参数说明

| 参数 | 说明 | 默认值 | 建议 |
|------|------|--------|------|
| `ema_period` | EMA 周期 | 144 | 144（日线）或 288（4小时线）|
| `rsi_period` | RSI 周期 | 14 | 14（标准）|
| `rsi_oversold` | 超卖阈值 | 30 | 25-35 |
| `rsi_overbought` | 超买阈值 | 70 | 65-75 |
| `stop_loss_pct` | 止损百分比 | 0.03 (3%) | 0.02-0.05 |
| `take_profit_pct` | 止盈百分比 | 0.06 (6%) | 0.05-0.10 |
| `use_bollinger_exit` | 使用布林带止盈 | true | true |
| `only_long` | 只做多模式 | true | true（推荐）|
| `max_leverage` | 最大杠杆 | 3.0 | 2.0-3.0 |
| `min_leverage` | 最小杠杆 | 2.0 | 1.5-2.0 |
| `max_risk_pct` | 每单最大风险 | 0.02 (2%) | 0.01-0.03 |

---

## 📊 策略优势与劣势

### ✅ 优势

1. **风险可控**
   - 每单最大亏损固定为 2%
   - 杠杆率严格限制
   - 避免爆仓风险

2. **趋势跟踪**
   - 只在明确趋势中交易
   - 避免震荡市场的假信号

3. **回调入场**
   - 在回调时入场，提高盈亏比
   - 不追涨杀跌

4. **长期生存**
   - 即使连续多次亏损，本金仍能支撑
   - 适合长期复利

5. **易于理解**
   - 逻辑清晰，参数可解释
   - 便于调试和优化

### ❌ 劣势

1. **错过趋势起点**
   - 等待回调可能错过趋势初期
   - 盈利可能不如追涨策略

2. **震荡市场表现不佳**
   - 在无趋势市场中可能频繁止损
   - 需要耐心等待明确趋势

3. **收益相对较低**
   - 低杠杆和严格风险控制导致单笔收益有限
   - 需要积累多笔交易实现复利

4. **依赖参数设置**
   - 参数不当可能导致策略失效
   - 需要针对不同市场调整参数

---

## 🔧 使用指南

### 启动策略

```bash
# 启动单体应用（包含交易循环）
python main_monolith.py
```

### 查看日志

```
INFO: Trading loop started in background
INFO: Starting trading loop for SOL-USDT-SWAP...
INFO: 不死鸟仓位计算: Fixed Risk: $2.00 (2.00%) | Position: 0.4000 units | Value: $60.00 | Leverage: 0.60x
INFO: TrendPullback Signal: BUY | Price: 150.00 | Trend: bullish | RSI: 28.50 | Reason: Bullish trend + RSI oversold (28.50 < 30)
INFO: ✓ BUY order executed successfully
```

### 健康检查

```bash
curl http://localhost:8000/health
```

### 运行测试

```bash
# 运行策略单元测试
python -m pytest tests/unit/strategy_engine/test_trend_pullback_strategy.py -v -s

# 运行所有测试
python -m pytest tests/ -v
```

---

## 📈 优化建议

### 针对不同时间框架

| 时间框架 | EMA 周期 | RSI 周期 | 建议 |
|---------|-----------|-----------|------|
| 1小时 | 144 | 14 | 适合日内交易 |
| 4小时 | 144 | 14 | 适合波段交易 |
| 日线 | 144 | 14 | 适合趋势交易 |

### 针对不同市场

| 市场 | RSI 超卖 | RSI 超买 | 建议 |
|------|-----------|-----------|------|
| 强趋势市场 | 35 | 65 | 放宽阈值，减少信号 |
| 震荡市场 | 25 | 75 | 收紧阈值，提高胜率 |
| 高波动市场 | 20 | 80 | 极端值入场，提高盈亏比 |

### 风险调整

- **保守型**: max_risk_pct = 1%, max_leverage = 2x
- **平衡型**: max_risk_pct = 2%, max_leverage = 3x
- **激进型**: max_risk_pct = 3%, max_leverage = 4x

---

## 📚 相关文档

- [策略引擎架构](../architecture/OKX_TRADING_SYSTEM_ARCHITECTURE.md)
- [风险管理](../RISK_MANAGEMENT.md)
- [仓位管理](./POSITION_MANAGEMENT.md)
- [测试指南](../TESTING_GUIDE.md)

---

## 📞 支持与反馈

如有问题或建议，请通过以下方式联系：

- 提交 Issue
- 发送邮件
- 加入讨论组

---

**最后更新**: 2024年12月28日
