# 双均线策略历史信号诊断脚本

## 🎯 功能概述

`debug_history.py` 是一个专门用于诊断双均线策略历史信号的脚本，可以帮助您验证在过去特定时间内是否存在遗漏的交易信号。

## 🚀 使用方法

### 基本用法
```bash
cd athena-trader
python scripts/debug_history.py
```

### 脚本特性
- ✅ 连接OKX Demo API获取真实历史数据
- ✅ 重演双均线策略（EMA9/EMA21）
- ✅ 逐根K线检测金叉/死叉信号
- ✅ 彩色输出，信号一目了然
- ✅ 特别关注凌晨时段信号
- ✅ 生成详细报告和日志

## 📊 输出说明

### 信号类型
- 🟢 **BUY**: 金叉信号（快线从下往上穿过慢线）
- 🔴 **SELL**: 死叉信号（快线从上往下穿过慢线）
- ⚪ **HOLD**: 无交叉信号
- 🟡 **WAIT**: 数据积累中（不足21根K线）

### 时间标记
- 🎨 **普通时间**: 白色显示
- 🎨 **凌晨0-2点**: 紫色高亮显示（关键时段）

## 📋 诊断报告解读

### 基本统计
```
📊 基本统计:
  总K线数: 100 根
  发现信号: 1 个
  买入信号: 0 个
  卖出信号: 1 个
  数据范围: 2025-12-18 08:30 到 2025-12-19 09:15
```

### 信号详情
```
🎯 信号详情:
  信号 1: SELL 🔴
    时间: 2025-12-19 01:00
    价格: $86394.60
    EMA9: 87874.34
    EMA21: 87896.41
    说明: 死叉: EMA9(87874.34) < EMA21(87896.41)
    K线索引: 66
    ⚠️  这是凌晨时段的信号！
```

### 关键时间段检查
```
🔍 关键时间段检查 (凌晨0-2点):
  发现 1 个凌晨时段的信号！
    2025-12-19 01:00 - SELL - 死叉: EMA9(87874.34) < EMA21(87896.41)
```

## 🔧 技术细节

### 策略参数
- **快线EMA**: 9周期
- **慢线EMA**: 21周期
- **时间框架**: 15分钟K线
- **数据范围**: 100根K线（约25小时）

### 信号判断逻辑
```python
# 金叉条件
if (current_fast > current_slow and 
    prev_fast <= prev_slow and 
    last_signal != "BUY"):
    return "BUY"

# 死叉条件  
elif (current_fast < current_slow and 
      prev_fast >= prev_slow and 
      last_signal != "SELL"):
    return "SELL"
```

## 📁 文件输出

### 控制台输出
- 实时彩色显示每根K线的策略重演过程
- 信号检测结果的即时反馈

### 日志文件
- **文件位置**: `debug_history.log`
- **内容**: 详细的技术日志和统计数据
- **用途**: 问题排查和深度分析

## 🎯 实际使用案例

### 发现遗漏信号
最近一次运行发现了重要的信号：
```
2025-12-19 01:00 86394.60 87874.34 87896.41 🔴 SELL 死叉: EMA9(87874.34) < EMA21(87896.41)
```

**分析结果**:
- ✅ 确认在凌晨1点确实存在一个死叉信号
- ✅ 信号符合策略判断逻辑
- ✅ 这是一个有效的卖出信号

## ⚠️ 注意事项

1. **网络连接**: 需要能访问OKX API
2. **时间同步**: 确保系统时间准确
3. **数据质量**: 脚本会自动验证和清理数据
4. **代理设置**: 如需代理，请配置环境变量

## 🔍 故障排除

### 常见问题

#### 1. 无法获取数据
```
❌ 无法获取历史数据，调试终止
```
**解决方案**:
- 检查网络连接
- 验证OKX Demo API配置
- 检查代理设置

#### 2. 没有发现信号
```
在检测的时间范围内没有发现任何买卖信号
```
**可能原因**:
- 市场处于盘整状态
- EMA线没有发生交叉
- 需要调整策略参数

#### 3. 时间戳问题
确保系统时区设置正确，脚本使用本地时间进行分析。

## 🚀 扩展功能

### 自定义参数
可以修改脚本中的以下参数：
```python
# 修改交易对
symbol = "ETH-USDT"

# 修改时间框架  
timeframe = "5m"

# 修改EMA周期
ema_fast = 12
ema_slow = 26
```

### 批量分析
可以通过循环调用脚本，对多个交易对进行分析。

## 📞 技术支持

如遇到问题，请检查：
1. 日志文件 `debug_history.log`
2. 网络连接状态
3. OKX API配置
4. Python环境和依赖

---

**最后更新**: 2025-12-19  
**版本**: 1.0  
**维护者**: Athena Trader Team
