# Athena Trader 项目架构报告（AI理解专用版）
*项目目前运行在新加坡服务器1G1CPU
## 1. 项目概览

**项目名称**：Athena Trader (Athena OS v3.0)
**项目类型**：加密货币量化交易系统
**目标交易所**：OKX（主要支持SWAP永续合约）
**架构模式**：事件驱动 + 异步微服务化

### 1.1 核心设计理念
- **事件驱动架构**：所有模块通过EventBus解耦，使用Pub/Sub模式通信
- **异步优先**：基于asyncio和aiohttp的高性能异步设计
- **依赖注入**：组件间松耦合，易于测试和扩展
- **策略分离**：策略只负责交易逻辑，不关心数据源和网络通信
- **风控贯穿**：资金管理、交易前检查、持仓对账等多层风控

---

## 2. 系统架构层次

### 2.1 入口层
**main.py**
- 功能：系统启动入口
- 职责：
  1. 配置日志系统
  2. 加载环境变量（.env文件）
  3. 从环境变量加载配置
  4. 初始化引擎
  5. 启动系统并监听退出信号
  6. 优雅退出处理

**配置加载流程**：
```
环境变量 (.env)
    ↓
load_config_from_env()
    ↓
配置字典 {
    total_capital: float,
    rest_gateway: {api_key, secret_key, passphrase, use_demo},
    public_ws: {symbol},
    private_ws: {use_demo},
    risk: {max_order_amount, max_frequency},
    strategies: [{id, type, capital, params}]
}
    ↓
Engine(config)
```

---

## 3. 核心模块

### 3.1 Core模块 (src/core/)

#### 3.1.1 Engine (主引擎)
**文件**：engine.py

**核心职责**：
- 系统的指挥官，负责组装所有组件
- 统一生命周期管理（initialize, start, stop）
- 依赖注入容器

**组件初始化顺序**：
1. EventBus（事件总线）
2. OMS组件
3. Gateway组件
4. 风控检查器
5. OrderManager（注入风控）
6. Strategies
7. 事件处理器注册
8. 策略资金分配

**关键方法**：
- `initialize()`: 初始化所有组件
- `start()`: 连接网关，启动策略，进入主循环
- `stop()`: 停止策略，断开网关，优雅退出
- `_load_strategy()`: 动态加载策略（支持vulture, sniper）
- `_register_event_handlers()`: 注册事件处理器
- `_allocate_strategy_capitals()`: 分配策略资金

**配置示例**：
```python
{
    'total_capital': 10000.0,
    'sync_threshold_pct': 0.10,
    'sync_cooldown_seconds': 60,
    'rest_gateway': {'use_demo': True, 'timeout': 10},
    'public_ws': {'symbol': 'BTC-USDT-SWAP', 'use_demo': True},
    'private_ws': {'use_demo': True},
    'risk': {'max_order_amount': 2000.0, 'max_frequency': 5, 'frequency_window': 1.0},
    'strategies': [...]
}
```

#### 3.1.2 EventBus (事件总线)
**文件**：event_bus.py

**设计原则**：
- 轻量级，零依赖
- 异步设计，支持高并发
- 类型安全，使用标准事件格式
- 解耦模块间依赖

**核心功能**：
- `register(event_type, handler)`: 注册事件处理器
- `unregister(event_type, handler)`: 取消注册
- `put(event)`: 异步发布事件
- `put_nowait(event)`: 非阻塞发布事件
- `start()`: 启动后台处理循环
- `stop()`: 停止并清空队列

**事件处理流程**：
```
Event发布 → Queue (maxsize=10000)
    ↓
后台循环 _process_loop()
    ↓
调用所有注册的处理器
    ↓
处理异常并发布ERROR事件
```

**统计信息**：
- published: 发布总数
- processed: 处理总数
- errors: 错误总数
- queue_size: 队列大小
- handlers: 处理器总数

#### 3.1.3 EventTypes (事件类型)
**文件**：event_types.py

**事件类型**：
- TICK: 行情Tick
- ORDER_SUBMITTED: 订单已提交
- ORDER_UPDATE: 订单状态更新
- ORDER_FILLED: 订单成交
- ORDER_CANCELLED: 订单取消
- POSITION_UPDATE: 持仓更新
- ERROR: 错误事件

---

### 3.2 OMS模块 (src/oms/)

#### 3.2.1 CapitalCommander (资金指挥官)
**文件**：capital_commander.py

**核心职责**：
- 管理总资金池
- 分配策略资金
- 追踪策略盈亏
- 实时更新资金状态
- **管理策略风控配置（RiskProfile）**
- **执行策略级别的风控检查**

**数据结构**：
```python
@dataclass
class StrategyCapital:
    allocated: float  # 分配资金
    used: float       # 已使用资金
    profit: float     # 累计盈亏
    available: float  # 可用资金 = allocated - used + profit
```

**关键方法**：
- `allocate_strategy(strategy_id, amount)`: 分配资金
- `check_buying_power(strategy_id, amount_usdt)`: 检查购买力
- `reserve_capital(strategy_id, amount_usdt)`: 预留资金（下单前）
- `release_capital(strategy_id, amount_usdt)`: 释放资金（撤单后）
- `record_profit(strategy_id, profit_usdt)`: 记录盈亏
- `on_order_filled(event)`: 监听订单成交事件，自动更新资金

**RiskProfile 管理方法**：
- `register_risk_profile(profile: RiskProfile)`: 注册策略风控配置
  - 存储策略的风控参数
  - 记录日志以便追踪
- `get_strategy_profile(strategy_id: str)`: 获取策略风控配置
  - 返回该策略的 RiskProfile
  - 未注册时返回 None
- `check_policy_compliance(strategy_id, amount_usdt, entry_price)`: 检查策略风控合规性
  - 检查单笔订单金额限制（max_order_size_usdt）
  - 检查策略最大杠杆限制（max_leverage）
  - 未注册 Profile 时使用默认保守配置

**资金计算逻辑**：
- 买入：释放预留资金
- 卖出：记录盈亏（简化处理，实际在PositionManager中计算）

**风控检查逻辑**：
1. 策略层风控（RiskProfile）：
   - 策略最大杠杆限制
   - 单笔订单金额限制
2. 全局层风控（RiskConfig）：
   - 全局杠杆上限（3x，最后一道防线）
   - 回撤熔断检查

#### 3.2.2 OrderManager (订单管理器)
**文件**：order_manager.py

**核心职责**：
- 接收策略下单请求
- 风控检查（集成PreTradeCheck）
- 调用Gateway发单
- 追踪订单状态
- 自动撤单

**数据结构**：
```python
@dataclass
class Order:
    order_id: str
    symbol: str
    side: str           # "buy" or "sell"
    order_type: str      # "market", "limit", "ioc"
    size: float
    price: float
    filled_size: float = 0.0
    status: str = "pending"  # pending, live, filled, cancelled, rejected
    strategy_id: str = "default"
    raw: dict = None
```

**关键方法**：
- `submit_order(symbol, side, order_type, size, price, strategy_id)`: 提交订单
  - 风控检查
  - 调用Gateway下单
  - 保存本地订单
  - 推送ORDER_SUBMITTED事件
- `cancel_order(order_id, symbol)`: 撤销订单
- `cancel_all_orders(symbol)`: 撤销所有订单
- `get_all_orders()`: 获取所有订单（用于测试）
- `on_order_update(event)`: 监听订单更新
- `on_order_filled(event)`: 监听订单成交
- `on_order_cancelled(event)`: 监听订单取消

**订单状态流转**：
```
pending → live → filled/cancelled/rejected
```

#### 3.2.3 PositionManager (持仓管理器)
**文件**：position_manager.py

**核心职责**：
- 实时维护本地持仓状态
- 计算持仓盈亏
- 处理期望持仓与实际持仓的同步（Shadow Ledger逻辑）
- **幽灵单防护**：持仓归零时自动撤销所有挂单

**数据结构**：
```python
@dataclass
class Position:
    symbol: str
    side: str           # "long" or "short"
    size: float         # 持仓数量
    entry_price: float  # 开仓均价
    unrealized_pnl: float = 0.0
    leverage: int = 1
    raw: dict = None

    @property
    signed_size(self) -> float:
        # 有符号持仓大小 (long=正, short=负)
```

**关键方法**：
- `update_from_event(event)`: 根据事件更新持仓
  - POSITION_UPDATE: 从API持仓对账
  - ORDER_FILLED: 从订单成交本地预计算
- `_update_position(api_position)`: 从API持仓更新
- `_update_position_from_order(order_filled)`: 从订单成交更新
- `_calculate_pnl(position, current_price)`: 计算盈亏
  - 多头: (当前价 - 开仓价) * 数量
  - 空头: (开仓价 - 当前价) * 数量
- `update_target_position(symbol, side, size)`: 更新策略期望持仓
- `_reconcile(api_position)`: 对账逻辑（Shadow Ledger核心）
  - 计算期望持仓与实际持仓的差异
  - 如果差异超过阈值（默认10%），触发同步
  - 冷却时间检查（默认60秒）
- `check_sync_needed(symbol)`: 检查是否需要同步
- **`cancel_all_stop_loss_orders(symbol)`**: 取消所有止损单（幽灵单防护）

**对账逻辑（Shadow Ledger）**：
```
1. 获取策略期望持仓: {symbol: {side, size, timestamp}}
2. 获取API实际持仓: {symbol: signed_size}
3. 计算差额: delta = target_signed_size - actual_signed_size
4. 计算偏差百分比: diff_pct = abs(delta) / abs(target_signed_size)
5. 如果 diff_pct > threshold (10%) → 触发同步
6. 冷却时间检查 (60秒)
```

**幽灵单防护逻辑**：
```
1. 监听 POSITION_UPDATE 事件
2. 检测持仓归零 (abs(size) < 0.001)
3. 触发 cancel_all_stop_loss_orders()
4. 撤销所有该交易对的挂单
5. 发布 ORDER_CANCELLED 事件
```

---

### 3.3 网关模块 (src/gateways/)

#### 3.3.1 BaseGateway (基类)
**文件**：base_gateway.py

**抽象方法**：
- `connect()`: 连接网关
- `disconnect()`: 断开网关
- `is_connected()`: 检查连接状态
- `get_balance()`: 获取余额
- `get_positions()`: 获取持仓
- `place_order()`: 下单
- `cancel_order()`: 撤单
- `get_kline()`: 获取K线

#### 3.3.2 OkxRestGateway (OKX REST API)
**文件**：okx/rest_api.py

**关键特性**：
- 持久Session复用（TCP Keep-Alive）
- 自动OKX V5 API签名（使用OkxSigner）
- 完整的异步上下文管理
- 低延迟，高吞吐量
- 统一的K线获取功能
- **支持止损单**：通过conditional订单类型实现stop_market

**核心类**：
```python
class OkxRestGateway(RestGateway):
    def __init__(self, api_key, secret_key, passphrase,
                 base_url="https://www.okx.com",
                 use_demo=False, timeout=10, event_bus=None)
```

**HTTP请求流程**：
```
1. 创建持久化ClientSession
   - limit=100
   - ttl_dns_cache=300
   - keepalive_timeout=30
   - enable_cleanup_closed=True

2. 生成请求头（使用OkxSigner）
   - timestamp: ISO格式
   - sign: HMAC-SHA256签名
   - OK-ACCESS-KEY/PASSPHRASE
   - x-simulated-trading: 1 (模拟模式)

3. 发送HTTP请求
   - GET: /api/v5/account/balance
   - GET: /api/v5/account/positions
   - POST: /api/v5/trade/order
   - POST: /api/v5/trade/cancel-order
   - GET: /api/v5/market/candles
   - POST: /api/v5/account/set-leverage

4. 解析响应
   - 检查HTTP状态码
   - 检查API错误码
   - 发布事件（await publish_event）
```

**下单字段白名单**（OKX V5 API支持）：
```python
okx_order_fields = {
    'instId', 'tdMode', 'side', 'ordType', 'sz', 'px',
    'reduceOnly', 'clOrdId', 'ccy', 'posSide'
}
```

**止损单实现**：
```python
# 处理止损单（stop_market / stop_limit）
if order_type in ['stop_market', 'stop_limit']:
    # OKX V5 使用 conditional 订单类型
    body['ordType'] = 'conditional'
    body['slTriggerType'] = 'last'
    body['slOrdPx'] = str(price)  # 止损触发价格

    # 条件单必须指定 posSide
    if side == 'sell':
        body['posSide'] = 'long'   # 多头止损
    else:
        body['posSide'] = 'short'  # 空头止损
```

**订单ID生成**：
```python
# clOrdId限制：1-32位字符，字母数字下划线
prefix = strategy_id[:4].lower()
ts_suffix = str(int(time.time() * 1000))[-8:]
clOrdId = f"{prefix}{ts_suffix}"
```

#### 3.3.3 OkxSigner (签名工具)
**文件**：okx/auth.py

**签名方法**：
```python
sign(timestamp, request_method, request_path, body, secret_key):
    message = timestamp + request_method + request_path + body
    signature = base64.b64encode(
        hmac.new(secret_key.encode('utf-8'),
                message.encode('utf-8'),
                hashlib.sha256).digest()
    ).decode()
```

#### 3.3.4 WebSocket网关
**文件**：
- okx/ws_base.py（WebSocket基类）
- okx/ws_public_gateway.py（公共WebSocket）
- okx/ws_private_gateway.py（私有WebSocket）

**功能**：
- 订阅公共行情（Tick数据）
- 订阅私有数据（订单更新、持仓更新）
- 自动重连机制
- 心跳保活

---

### 3.4 策略模块 (src/strategies/)

#### 3.4.1 BaseStrategy (策略基类)
**文件**：base_strategy.py

**核心设计**：
- 策略只负责交易逻辑，不关心数据源
- 通过事件总线接收市场数据
- 纯粹的策略实现，不包含网络通信
- **支持自带风控配置（RiskProfile）**

**基类接口**：
```python
class BaseStrategy(ABC):
    @abstractmethod
    async def on_tick(self, event: Event):
        """处理Tick事件（策略核心方法）"""
        pass

    @abstractmethod
    async def on_signal(self, signal: Dict[str, Any]):
        """处理策略信号"""
        pass

    async def buy(self, symbol, size, order_type="market", price=None) -> bool
    async def sell(self, symbol, size, order_type="market", price=None) -> bool
    async def start(self)  # 启动策略
    async def stop(self)   # 停止策略
```

**风控配置**：
- `self.risk_profile: RiskProfile` - 策略风控配置
- 初始化时使用默认保守配置（1x 杠杆，硬价格止损）
- `set_risk_profile(profile: RiskProfile)` - 子类可覆盖默认配置
- `start()` 方法自动注册风控配置到 CapitalCommander

**便捷方法**：
- `buy()`: 买入
- `sell()`: 卖出

**内部流程**（_submit_order）：
1. 冷却检查（默认5秒）
2. 检查OrderManager是否注入
3. 检查CapitalCommander是否注入 → 资金检查
4. 提交订单
5. 更新统计信息

**统计信息**：
- ticks_received: 收到的Tick数
- signals_generated: 生成的信号数
- orders_submitted: 提交的订单数

#### 3.4.2 SniperStrategy (HFT狙击策略)
**文件**：hft/sniper.py

**策略逻辑**：
- 监听TICK事件
- 检测单笔交易金额超过阈值（默认5000 USDT）
- 买入方向跟随大单
- 设置冷却时间（默认5秒）防止重复触发

**配置类**：
```python
@dataclass
class SniperConfig:
    symbol: str = "BTC-USDT-SWAP"
    position_size: float = 0.1      # 每次下单数量
    cooldown_seconds: float = 5.0   # 冷却时间（秒）
    order_type: str = "market"      # 订单类型
    min_big_order_usdt: float = 5000.0  # 大单阈值（USDT）
```

**核心逻辑**（on_tick）：
```
1. 检查策略是否启用
2. 检查冷却时间
3. 解析Tick数据（symbol, price, size, side, usdt_value）
4. 检查交易对是否匹配
5. 增加Tick计数
6. 检测大单: if usdt_value >= min_big_order_usdt
7. 跟随交易:
   - 大单买入 → 我们也买入
   - 大单卖出 → 我们也卖出
   - position_size强制取整（OKX SWAP合约要求整数）
```

**统计信息**：
- big_orders_detected: 检测到大单数量
- big_order_amount_total: 大单总金额
- avg_big_order_amount: 平均大单金额

#### 3.4.3 其他策略
- **VultureStrategy** (hft/vulture.py)：秃鹫策略
- **DualEMAStrategy** (trend/dual_ema.py)：双EMA趋势策略
- **PullbackStrategy** (trend/pullback.py)：回调策略

---

### 3.5 风控模块 (src/risk/)

#### 3.5.1 RiskProfile (风控配置文件)
**文件**：config/risk_profile.py

**核心职责**：
- 定义策略级别的风控配置
- 实现策略与风控的解耦
- 支持不同策略类型的差异化风控参数

**数据结构**：
```python
@dataclass
class RiskProfile:
    """策略风控配置文件"""
    strategy_id: str

    # 杠杆限制
    max_leverage: float = 1.0          # 该策略允许的最大真实杠杆

    # 单笔风控
    max_order_size_usdt: float = 1000.0 # 单笔最大名义价值
    single_loss_cap_pct: float = 0.01   # 单笔最大亏损占总资金比例 (1% Rule)

    # 止损模式
    stop_loss_type: StopLossType = StopLossType.HARD_PRICE

    # HFT 特有配置
    time_limit_seconds: int = 0        # 持仓最大时间 (秒), 0为不限制

    # 每日熔断
    max_daily_loss_pct: float = 0.05   # 当日累计亏损超过5%停止该策略

class StopLossType(Enum):
    """止损类型枚举"""
    HARD_PRICE = "hard_price"    # 硬价格止损（传统）
    TIME_BASED = "time_based"    # 时间止损（HFT 专用）
    TRAILING = "trailing"        # 移动止损（趋势专用）
```

**关键方法**：
- `is_hft_style()`: 判断是否为 HFT 风格配置
- `is_trend_style()`: 判断是否为趋势策略风格配置
- `is_conservative()`: 判断是否为保守配置

**默认配置**：
- `DEFAULT_CONSERVATIVE_PROFILE`: 保守默认值（1x 杠杆，硬价格止损）

#### 3.5.2 RiskConfig (风控配置)
**文件**：risk_config.py

**核心职责**：
- 定义全局风控参数
- 机构级资金管理系统的硬性参数配置

**关键配置**：
```python
@dataclass
class RiskConfig:
    # 单笔交易风险控制
    RISK_PER_TRADE_PCT: float = 0.01  # 每笔交易风险不超过总资金的1%

    # 杠杆控制
    MAX_GLOBAL_LEVERAGE: float = 3.0  # 全局真实杠杆上限（绝对红线）

    # 回撤控制
    MAX_DRAWDOWN_LIMIT: float = 0.15  # 策略最大回撤熔断阈值

    # 止损保护
    DEFAULT_STOP_LOSS_PCT: float = 0.02  # 默认止损百分比
    MIN_STOP_DISTANCE_PCT: float = 0.001  # 最小止损价差保护
```

#### 3.5.3 PreTradeCheck (交易前检查)
**文件**：pre_trade.py

**核心职责**：
- 在下单前执行风险检查
- 防止异常交易

**检查项**：
1. **单笔订单金额检查**：
   - 默认阈值：2000 USDT
   - 超过则拒绝

2. **下单频率检查**：
   - 默认限制：1秒内 < 5单
   - 超过则拒绝

**核心方法**：
```python
def check(order: dict) -> tuple[bool, Optional[str]]:
    """
    返回: (是否通过, 拒绝原因)
    """
    # 1. 检查订单金额
    if amount_usdt > max_order_amount:
        return False, "订单金额超限"

    # 2. 检查下单频率
    self._clean_order_history(current_time)
    if recent_count >= max_frequency:
        return False, "下单频率过高"

    # 3. 记录订单
    self._order_history[current_time] = order_id

    return True, None
```

**订单历史清理**：
- 保留frequency_window（默认1秒）内的订单
- 超时的订单自动清理

**统计信息**：
- total_checks: 总检查次数
- total_rejections: 总拒绝次数
- rejection_rate: 拒绝率
- recent_orders: 近期订单数

---

## 4. 工具模块 (src/utils/)

### 4.1 Logger (日志系统)
**文件**：logger.py
- 支持多级别日志
- 文件日志输出
- 控制台日志输出

### 4.2 Config (配置管理)
**文件**：config.py
- 从环境变量加载配置
- 配置验证
- 默认值处理

### 4.3 Auth (认证工具)
**文件**：auth.py
- API密钥管理
- 签名生成

### 4.4 Cache (缓存)
**文件**：cache.py
- 内存缓存
- Redis缓存支持

### 4.5 Math (数学工具)
**文件**：math.py
- 价格计算
- 数量计算
- 精度处理

### 4.6 Time (时间工具)
**文件**：time.py
- 时间戳转换
- 时区处理
- 延迟工具

---

## 5. 配置系统

### 5.1 配置文件结构
```
config/
├── base.json         # 基础配置
├── development.json   # 开发环境
├── docker-daemon.json # Docker配置
├── local.json        # 本地环境
├── production.json    # 生产环境
└── test.json        # 测试环境
```

### 5.2 环境变量
**必需变量**：
- `OKX_API_KEY`: OKX API密钥
- `OKX_SECRET_KEY`: OKX密钥
- `OKX_PASSPHRASE`: OKX密码短语

**可选变量**：
- `TOTAL_CAPITAL`: 总资金（默认10000 USDT）
- `TRADING_SYMBOL`: 交易对（默认BTC-USDT-SWAP）
- `USE_DEMO`: 是否使用模拟交易（默认true）
- `MAX_ORDER_AMOUNT`: 最大单笔订单金额（默认2000 USDT）
- `MAX_FREQUENCY`: 最大下单频率（默认5单/1s）
- `LOG_LEVEL`: 日志级别（默认INFO）

**策略变量**：
- `ENABLE_SNIPER`: 是否启用狙击策略（默认true）
- `SNIPER_CAPITAL`: 狙击策略资金（默认2000 USDT）
- `SNIPER_POSITION_SIZE`: 每次下单数量（默认0.1）
- `SNIPER_COOLDOWN`: 冷却时间（默认5秒）
- `SNIPER_ORDER_TYPE`: 订单类型（默认market）
- `SNIPER_MIN_BIG_ORDER`: 大单阈值（默认5000 USDT）

---

## 6. 数据流分析

### 6.1 市场数据流
```
WebSocket公共网关
    ↓ 订阅行情
TICK事件
    ↓ publish()
EventBus队列
    ↓ process_loop()
Strategy.on_tick()
    ↓ 处理逻辑
OrderManager.submit_order()
    ↓ 风控检查
Gateway.place_order()
    ↓ REST API
交易所
```

### 6.2 订单数据流
```
策略下单请求
    ↓
OrderManager.submit_order()
    ↓ 风控检查
OkxRestGateway.place_order()
    ↓ HTTP POST
交易所返回订单ID
    ↓ 本地保存
EventBus.publish(ORDER_SUBMITTED)
    ↓
监听器处理:
  - CapitalCommander: 预留资金
  - OrderManager: 更新状态
```

### 6.3 订单成交流
```
交易所推送成交事件
    ↓ WebSocket私有网关
EventBus.publish(ORDER_FILLED)
    ↓
监听器处理:
  - CapitalCommander: 释放资金/记录盈亏
  - OrderManager: 更新订单状态
  - PositionManager: 更新持仓
```

### 6.4 持仓同步流
```
定期查询持仓（REST API）
    ↓
EventBus.publish(POSITION_UPDATE)
    ↓
PositionManager.update_from_event()
    ↓
对账逻辑 _reconcile()
    ↓
检查期望持仓 vs 实际持仓
    ↓
差异超过阈值？
    ↓ YES
生成同步计划（RESYNC）
    ↓
策略执行同步操作
```

### 6.5 幽灵单防护流
```
POSITION_UPDATE事件（持仓归零）
    ↓
PositionManager.update_from_event()
    ↓
检测 size ≈ 0
    ↓
触发 cancel_all_stop_loss_orders()
    ↓
撤销所有该交易对的挂单
    ↓
发布 ORDER_CANCELLED 事件
    ↓
OrderManager 处理撤单确认
```

---

## 7. 依赖分析

### 7.1 核心依赖
```
核心框架:
- asyncio: 异步编程（内置）
- aiohttp==3.10.5: HTTP客户端
- websockets==13.1: WebSocket客户端
- python-dotenv==1.0.0: 环境变量管理

数据处理:
- pandas==2.2.3: 数据分析
- numpy==1.23.5: 数值计算

验证和配置:
- pydantic==2.8.2: 数据验证
- pydantic-settings==2.4.0: 配置管理

安全:
- cryptography==42.0.8: 加密和签名

监控:
- watchdog==5.0.2: 文件监控

测试:
- pytest==7.4.3: 测试框架
- pytest-cov==4.1.0: 覆盖率
- pytest-asyncio==0.21.1: 异步测试
- pytest-mock==3.12.0: Mock工具
```

### 7.2 模块依赖关系
```
main.py
    ↓
Engine (core/engine.py)
    ↓
EventBus (core/event_bus.py)
    ├→ CapitalCommander (oms/capital_commander.py)
    ├→ PositionManager (oms/position_manager.py)
    ├→ OrderManager (oms/order_manager.py)
    │   └→ PreTradeCheck (risk/pre_trade.py)
    ├→ OkxRestGateway (gateways/okx/rest_api.py)
    │   └→ OkxSigner (gateways/okx/auth.py)
    ├→ OkxPublicWsGateway (gateways/okx/ws_public_gateway.py)
    ├→ OkxPrivateWsGateway (gateways/okx/ws_private_gateway.py)
    └→ Strategies
        ├→ BaseStrategy (strategies/base_strategy.py)
        ├→ SniperStrategy (strategies/hft/sniper.py)
        ├→ VultureStrategy (strategies/hft/vulture.py)
        ├→ DualEMAStrategy (strategies/trend/dual_ema.py)
        └→ PullbackStrategy (strategies/trend/pullback.py)
```

---

## 8. 关键技术点

### 8.1 异步编程模型
- **核心框架**: asyncio
- **HTTP客户端**: aiohttp（持久Session复用）
- **WebSocket**: websockets库
- **事件循环**: 统一由Engine管理

### 8.2 事件驱动架构
- **EventBus**: 轻量级Pub/Sub
- **事件队列**: asyncio.Queue (maxsize=10000)
- **事件处理器**: 异步函数，可注册多个
- **错误处理**: 自动捕获并发布ERROR事件

### 8.3 依赖注入
- **组件初始化**: Engine统一管理
- **接口注入**: EventBus, OrderManager, CapitalCommander
- **松耦合**: 模块间通过EventBus通信

### 8.4 风控机制
- **交易前检查**: PreTradeCheck
  - 金额限制
  - 频率限制
- **资金管理**: CapitalCommander
  - 资金分配
  - 购买力检查
  - 盈亏追踪
- **持仓对账**: Shadow Ledger
  - 期望持仓 vs 实际持仓
  - 差异阈值触发同步
  - 冷却时间防止频繁同步
- **幽灵单防护**: PositionManager
  - 持仓归零自动撤单
  - 防止止损单"幽灵化"

### 8.5 签名认证
- **算法**: HMAC-SHA256
- **实现**: OkxSigner类
- **时机**: 每次REST API请求前

### 8.6 性能优化
- **Session复用**: TCP Keep-Alive
- **连接池**: aiohttp.TCPConnector (limit=100)
- **DNS缓存**: ttl_dns_cache=300
- **异步非阻塞**: 所有IO操作异步化

---

## 9. 测试架构

### 9.1 测试结构
```
tests/
├── conftest.py          # 测试配置
├── conftest_fixed.py    # 修复的配置
├── run_all_tests.py     # 运行所有测试
├── integration/         # 集成测试
│   └── test_hft_integration.py
├── stress/            # 压力测试
│   └── test_hft_stress.py
├── unit/              # 单元测试
├── utils/             # 测试工具
│   └── base_test_runner.py
└── reports/           # 测试报告
    ├── coverage.xml
    ├── benchmarks/
    ├── coverage/
    └── html/coverage/  # HTML覆盖率报告
```

### 9.2 测试工具
- pytest: 测试框架
- pytest-cov: 覆盖率
- pytest-asyncio: 异步测试
- pytest-mock: Mock工具

### 9.3 生产级测试脚本
**文件**：scripts/test_critical_patches_demo.py

**测试内容**：
1. **补丁一：硬止损重试机制**
   - 测试止损单自动提交
   - 验证重试逻辑

2. **补丁二：幽灵单防护**
   - 测试持仓归零时自动撤单
   - 验证止损单被撤销

3. **补丁三：动态交易对加载**
   - 测试从API获取交易对
   - 验证交易对注册

**测试环境**：
- OKX 模拟盘（Demo Trading）
- SOL-USDT-SWAP 交易对
- 约 100 USDT 测试资金

**测试结果**：
- ✅ 补丁一：硬止损重试机制 - 通过
- ✅ 补丁二：幽灵单防护 - 通过（Mock测试）
- ✅ 补丁三：动态交易对加载 - 通过

**注意**：
- 补丁二由于 OKX 模拟盘限制（不支持限价单），使用 Mock 测试验证
- 生产环境部署前需要在实盘验证

---

## 10. 部署架构

### 10.1 Docker支持
```
Dockerfile
docker-compose.yml
```

### 10.2 配置环境
- base.json: 基础配置
- development.json: 开发环境
- production.json: 生产环境
- test.json: 测试环境

### 10.3 脚本工具
```
scripts/
├── start.py                   # 启动脚本
├── cleanup_positions.py        # 清理持仓脚本
├── verify_deployment.py      # 部署验证
├── test_strategy_tick.py     # 策略测试
├── test_ws_debug.py        # WebSocket调试
├── test_ws_gateway.py      # WebSocket网关测试
├── test_ws_raw.py          # 原始WebSocket测试
├── debug_auth.py           # 认证调试
├── test_critical_patches.py  # 生产级补丁测试
└── deployment/deploy.sh     # 部署脚本
```

---

## 11. 遗留代码管理

### 11.1 _legacy_trash目录
```
_legacy_trash/
├── circuit_breaker_hft.py
├── dependencies.py
├── emergency_actions.py
├── environment_utils.py
├── main_monolith.py
├── order_checks.py
├── shadow_ledger.py
├── data_manager/
├── executor/
├── high_frequency/
├── monitoring/
├── risk_manager/
└── strategy_engine/
```

**说明**：这些是旧版本代码，已废弃但保留用于参考。新版本已整合到src/目录下。

---

## 12. 系统启动流程

```
main.py
    ↓
1. 配置日志系统
    ↓
2. 加载环境变量
    ↓
3. 从环境变量加载配置
    ↓
4. 创建Engine实例
    ↓
5. engine.initialize():
    5.1 创建EventBus
    5.2 创建OMS组件
    5.3 创建Gateways
    5.4 创建风控检查器
    5.5 创建OrderManager（注入风控）
    5.6 加载Strategies
    5.7 注册事件处理器
    5.8 分配策略资金
    ↓
6. engine.start():
    6.1 连接Gateways
    6.2 设置杠杆（10x）
    6.3 启动Strategies
    6.4 设置信号处理（Ctrl+C）
    6.5 进入主循环（while _running）
    ↓
7. 等待退出信号
    ↓
8. engine.stop():
    8.1 停止Strategies
    8.2 断开Gateways
    8.3 停止EventBus
    ↓
9. 优雅退出
```

---

## 13. 关键数据结构汇总

### 13.1 订单数据
```python
Order:
    order_id: str
    symbol: str
    side: str (buy/sell)
    order_type: str (market/limit/ioc/stop_market)
    size: float
    price: float
    filled_size: float
    status: str (pending/live/filled/cancelled/rejected)
    strategy_id: str
    raw: dict (原始API数据)
```

### 13.2 持仓数据
```python
Position:
    symbol: str
    side: str (long/short)
    size: float
    entry_price: float
    unrealized_pnl: float
    leverage: int
    raw: dict
    signed_size: float (正=long, 负=short)
```

### 13.3 资金数据
```python
StrategyCapital:
    allocated: float    # 分配资金
    used: float         # 已使用资金
    profit: float       # 累计盈亏
    available: float   # 可用资金
```

### 13.4 事件数据
```python
Event:
    type: EventType
    data: dict
    source: str
```

---

## 14. 风险控制体系

### 14.1 多层风控架构
```
第一层：交易前检查（PreTradeCheck）
    - 金额限制
    - 频率限制

第二层：策略级风控（RiskProfile）
    - 策略最大杠杆限制
    - 单笔订单金额限制
    - 止损类型配置
    - 每日熔断比例
    - 时间止损（HFT 专用）

第三层：资金管理（CapitalCommander）
    - 购买力检查
    - 资金分配
    - 盈亏追踪
    - 全局杠杆上限（3x，最后一道防线）

第四层：持仓对账（Shadow Ledger）
    - 期望持仓 vs 实际持仓
    - 差异阈值触发同步
    - 冷却时间防止频繁同步

第五层：幽灵单防护
    - 持仓归零自动撤单
    - 防止止损单"幽灵化"
```

### 14.2 风控参数

#### 14.2.1 全局风控参数（RiskConfig）
```python
# PreTradeCheck
max_order_amount: 2000.0 USDT
max_frequency: 5 单 / 1 秒
frequency_window: 1.0 秒

# CapitalCommander
total_capital: 10000.0 USDT
MAX_GLOBAL_LEVERAGE: 3.0  # 全局杠杆上限（绝对红线）

# PositionManager (Shadow Ledger)
sync_threshold_pct: 10%  # 差异阈值
sync_cooldown_seconds: 60  # 同步冷却时间
```

#### 14.2.2 策略级风控参数（RiskProfile）
```python
@dataclass
class RiskProfile:
    # 杠杆限制
    max_leverage: float = 1.0          # 策略允许的最大杠杆
    max_order_size_usdt: float = 1000.0 # 单笔最大名义价值

    # 单笔风控
    single_loss_cap_pct: float = 0.01   # 单笔最大亏损占比

    # 止损模式
    stop_loss_type: StopLossType = StopLossType.HARD_PRICE
    #   - HARD_PRICE: 硬价格止损（传统）
    #   - TIME_BASED: 时间止损（HFT 专用）
    #   - TRAILING: 移动止损（趋势专用）

    # HFT 特有配置
    time_limit_seconds: int = 0        # 持仓最大时间（秒）

    # 每日熔断
    max_daily_loss_pct: float = 0.05   # 当日累计亏损超过5%停止该策略
```

### 14.3 策略风控配置示例

#### 14.3.1 HFT 策略配置（激进）
```python
RiskProfile(
    strategy_id="hft_sniper",
    max_leverage=5.0,              # 允许 5 倍杠杆
    max_order_size_usdt=500.0,     # 单笔 500 USDT
    single_loss_cap_pct=0.005,     # 单笔最大亏损 0.5%
    stop_loss_type=StopLossType.TIME_BASED,
    time_limit_seconds=10,          # 10 秒强制平仓
    max_daily_loss_pct=0.05        # 每日最大亏损 5%
)
```

#### 14.3.2 趋势策略配置（保守）
```python
RiskProfile(
    strategy_id="trend_dual_ema",
    max_leverage=1.5,              # 允许 1.5 倍杠杆
    max_order_size_usdt=2000.0,    # 单笔 2000 USDT
    single_loss_cap_pct=0.015,     # 单笔最大亏损 1.5%
    stop_loss_type=StopLossType.TRAILING,
    time_limit_seconds=0,          # 无时间限制
    max_daily_loss_pct=0.03        # 每日最大亏损 3%
)
```

#### 14.3.3 默认配置（保守）
```python
DEFAULT_CONSERVATIVE_PROFILE = RiskProfile(
    strategy_id="default",
    max_leverage=1.0,              # 1 倍杠杆（无杠杆）
    max_order_size_usdt=1000.0,   # 单笔 1000 USDT
    single_loss_cap_pct=0.01,      # 单笔最大亏损 1%
    stop_loss_type=StopLossType.HARD_PRICE,
    time_limit_seconds=0,
    max_daily_loss_pct=0.05        # 每日最大亏损 5%
)
```

### 14.4 风控检查流程

#### 14.4.1 下单风控检查流程
```
策略下单请求
    ↓
1. 冷却检查（BaseStrategy）
   - 检查冷却时间是否已过
    ↓
2. PreTradeCheck（交易前检查）
   - 检查订单金额是否超限
   - 检查下单频率是否超限
    ↓
3. 资金检查（CapitalCommander）
   - 检查购买力是否充足
    ↓
4. 策略风控检查（check_policy_compliance）
   - 检查单笔订单金额（max_order_size_usdt）
   - 检查策略杠杆是否超限（max_leverage）
    ↓
5. 全局风控检查
   - 全局杠杆是否超限（MAX_GLOBAL_LEVERAGE 3x）
    ↓
6. 提交订单
```

#### 14.4.2 风控违规处理
- 拒绝订单并记录日志
- 发布 ERROR 事件
- 策略可选择重试或放弃

### 14.5 风控架构优势

#### 14.5.1 策略解耦
✅ 每个策略可以独立配置风控参数
✅ 策略不关心全局风控逻辑，只定义自己的风险偏好
✅ 易于扩展新的风控维度

#### 14.5.2 差异化配置
✅ HFT 策略：5x 杠杆，时间止损，10秒强制平仓
✅ 趋势策略：1.5x 杠杆，移动止损
✅ 保守策略：1x 杠杆，硬价格止损

#### 14.5.3 双层防护
✅ 策略层风控（Profile）：第一道防线，针对性强
✅ 全局层风控（RiskConfig）：第二道防线，保护全局资金
✅ 全局杠杆上限（3x）作为最后一道防线，不可突破

#### 14.5.4 向下兼容
✅ 未注册 Profile 的策略使用默认保守配置
✅ 全局杠杆限制保留，不影响现有风控逻辑
✅ 现有 API 签名完全不变

---

## 15. 性能指标

### 15.1 并发能力
- 连接池大小: 100
- 事件队列大小: 10000
- WebSocket自动重连
- Session Keep-Alive: 30秒

### 15.2 延迟优化
- DNS缓存: 300秒
- 异步非阻塞IO
- 持久Session复用
- TCP Keep-Alive

---

## 16. 总结

### 16.1 架构优势
1. **事件驱动**: 模块解耦，易于扩展
2. **异步优先**: 高性能，低延迟
3. **依赖注入**: 松耦合，易测试
4. **多层风控**: 资金、频率、持仓全面保护
5. **策略分离**: 交易逻辑独立，快速迭代

### 16.2 核心特点
- 支持多策略并发运行
- 实时持仓对账（Shadow Ledger）
- 完整的资金管理体系
- 自动化风控机制
- 支持模拟和实盘交易
- **幽灵单防护**：持仓归零自动撤单
- **止损单支持**：通过conditional订单类型实现

### 16.3 技术栈
- Python 3.x
- asyncio + aiohttp
- OKX V5 API
- pytest测试框架
- Docker部署支持

### 16.4 关键修复（2026年1月）
1. **修复 OrderManager 方法名**：subscribe → register
2. **修复 PositionManager await**：确保事件正确处理
3. **修复 publish_event await**：确保事件正确发送
4. **添加止损单支持**：通过conditional订单类型
5. **添加幽灵单防护**：持仓归零自动撤单
6. **添加测试脚本**：生产级补丁验证

---

**报告生成时间**: 2026年1月12日
**项目版本**: Athena OS v3.0
**适用对象**: AI理解和架构分析
