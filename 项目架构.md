# Athena Trader 项目架构报告

**项目**: Athena OS v3.1
**类型**: 加密货币量化交易系统
**目标交易所**: OKX (主要支持SWAP永续合约)
**架构**: 事件驱动 + 异步微服务化

---

## 1. 项目概览

**项目名称**：Athena Trader
**项目类型**：加密货币量化交易系统
**目标交易所**：OKX (主要支持SWAP永续合约)
**架构模式**：事件驱动 + 异步微服务化

---

## 2. 系统架构层次

```
用户接口
    ↓
main.py (入口)
    ↓
Engine (核心引擎)
    ↓
EventBus (事件总线)
    ↓
组件注入
    ├─ CapitalCommander (资金管理)
    ├─ OrderManager (订单管理)
    ├─ PositionManager (持仓管理)
    └─ Strategies (策略)
        ├─ BaseStrategy (基类)
        └─ ScalperV1 (HFT剥头皮)
    ↓
Gateways (网关)
    ├─ OkxRestGateway (REST API)
    ├─ OkxPublicWsGateway (公共行情)
    └─ OkxPrivateWsGateway (私有数据)
```

---

## 3. 核心模块

### 3.1 Core模块 (src/core/)

**Engine**: 系统核心，负责组件组装和生命周期管理

**EventBus**: 事件驱动架构核心，Pub/Sub模式，异步处理

**EventTypes**: TICK, ORDER_SUBMITTED, ORDER_UPDATE, ORDER_FILLED, ORDER_CANCELLED, POSITION_UPDATE, ERROR

---

### 3.2 OMS模块 (src/oms/)

**CapitalCommander**: 资金管理、策略资金分配、盈亏追踪、风控检查

**OrderManager**: 订单生命周期管理、状态跟踪、止损单自动发送

**PositionManager**: 持仓管理、Shadow Ledger对账、幽灵单防护、定时同步

---

### 3.3 Gateways模块 (src/gateways/)

**BaseGateway**: 网关抽象接口

**OkxRestGateway**: OKX REST API (持久Session、HMAC签名、V5 API支持)

**OkxPublicWsGateway**: 公共WebSocket (行情Tick订阅)

**OkxPrivateWsGateway**: 私有WebSocket (订单/持仓推送、心跳保活)

---

## 4. 策略模块 (src/strategies/)

**BaseStrategy**: 策略基类、买入/卖出接口、事件处理

**ScalperV1**: HFT剥头皮策略 (微观结构失衡、Maker模式、时间止损)

---

## 5. 配置系统

**配置文件**: base.json, development.json, local.json, production.json, test.json

**环境变量**: .env (API密钥、总资金、交易对等)

---

## 6. 数据流

### 6.1 市场数据流
```
OkxPublicWsGateway
    ↓ subscribe(TICK)
EventBus
    ↓ process_loop()
Strategy.on_tick()
    ↓ 处理逻辑
OrderManager.submit_order()
    ↓ 风控检查
Gateway.place_order()
    ↓ REST API
交易所
```

### 6.2 订单数据流
```
策略下单请求
    ↓
OrderManager.submit_order()
    ↓ 风控检查
OkxRestGateway.place_order()
    ↓ HTTP POST
交易所返回订单ID
    ↓ 本地保存Order对象
    ↓ EventBus.publish(ORDER_SUBMITTED)
    ↓
监听器处理:
  - CapitalCommander: 预留资金
  - OrderManager: 更新订单状态
```

### 6.3 订单成交流
```
交易所推送成交事件
    ↓ WebSocket私有网关
EventBus.publish(ORDER_FILLED)
    ↓
OrderManager.on_order_filled()
    ↓ 更新订单状态
    ↓ CapitalCommander: 释放资金/记录盈亏
    ↓ PositionManager: 更新持仓
    ↓ 自动发送止损单 (Stop Market)
```

### 6.4 持仓同步流
```
定期查询持仓（REST API）
    ↓
EventBus.publish(POSITION_UPDATE)
    ↓
PositionManager.update_from_event()
    ↓ 对账逻辑 Shadow Ledger
    ↓ 发现不一致时强制同步
```

---

## 7. 技术栈

**Python**: 3.x (异步优先)

**核心框架**:
- asyncio (异步事件循环)
- aiohttp (HTTP客户端，持久Session)
- websockets (WebSocket客户端)

**依赖**:
- pydantic (数据验证)
- python-dotenv (环境变量)
- cryptography (HMAC-SHA256签名)

**测试**:
- pytest (单元测试框架)
- pytest-asyncio (异步测试)
- pytest-mock (Mock工具)

---

## 8. 关键特性

### 8.1 风控机制
- **策略级风控**: RiskProfile (杠杆、止损类型、订单限制)
- **全局风控**: RiskConfig (1% Rule、3x杠杆上限、回撤熔断)
- **交易前检查**: PreTradeCheck (金额、频率、敞口)
- **资金管理**: CapitalCommander (分配、预留、释放、盈亏追踪)
- **对账机制**: Shadow Ledger (期望持仓 vs 实际持仓)
- **幽灵单防护**: PositionManager (持仓归零自动撤单)
- **定时持仓同步**: PositionManager (定期从 REST API 获取真实持仓)

### 8.2 性能优化
- **轻量化**: 无pandas/numpy依赖 (节省200-300MB内存)
- **O(1)算法**: ScalperV1使用原生Python累加器
- **异步非阻塞**: 所有IO操作异步化

### 8.3 稳定性增强
- **指数退避**: PositionManager同步失败时自动增加重试间隔(1s→60s)
- **熔断保护**: 连续失败10次后暂停60秒
- **心跳保活**: WebSocket连接看门狗(30秒超时强制重连)
- **接收循环优化**: 确保所有异常分支正确退出，避免死循环刷屏

---

## 9. 总结

### 9.1 架构优势
1. **事件驱动**: 模块解耦，易于扩展
2. **异步优先**: 高性能，低延迟
3. **依赖注入**: 松耦合，易测试
4. **多层风控**: 资金、频率、持仓全面保护
5. **策略分离**: 交易逻辑独立，快速迭代
6. **轻量化**: 针对1G内存环境优化

### 9.2 核心特点
- 支持多策略并发运行
- 实时持仓对账 (Shadow Ledger)
- 完整的资金管理体系
- 自动化风控机制
- 支持模拟和实盘交易

---

## 10. 关键修复记录

### 10.1 高优先级修复 (2026-01-20)

**1. OrderManager资金检查缺失** ✅
- 添加 CapitalCommander 依赖注入
- submit_order 前调用 check_buying_power()
- 避免订单被交易所拒绝

**2. PositionManager同步循环死锁** ✅
- 添加指数退避机制 (1s → 60s)
- 添加熔断保护 (连续失败10次触发)
- 添加自动恢复机制

**3. BaseStrategy市价单止损逻辑错误** ✅
- 优化止损价判断逻辑
- 市价单允许止损价=0，但不发送止损单
- 保持限价单的原有逻辑（必须提供有效止损价）

**修复效果**:
- ✅ 资金不足订单不再被交易所拒绝
- ✅ 同步循环不再无限重试
- ✅ 日志不再爆炸
- ✅ 市价平仓不再被阻塞

### 10.2 止损价格传递丢失修复 (2026-01-22) 🔥

**1. BaseStrategy未传递止损价格** ✅
- submit_order 方法现在正确传递 stop_loss_price 参数
- OrderManager 能正确接收止损价格

**2. OrderManager未保存止损价格到Order对象** ✅
- Order 类添加 stop_loss_price 字段
- 创建 Order 对象时保存 stop_loss_price
- on_order_filled 回调能从本地 Order 获取止损价格

**3. 市价单跳过资金检查** ✅
- 市价单（用于紧急平仓）跳过资金检查
- 确保时间止损和硬止损能正常执行

**修复效果**:
- ✅ 日志显示 "Stop: 126.70" 而非 "Stop: NONE"
- ✅ 订单成交后自动发送止损单
- ✅ 市价平仓不再被 "资金不足" 拦截
- ✅ 止损价格不再丢失

---

## 11. 总结

**修复完成！**
✅ 所有3个关键问题已全部修复
✅ Order 类定义添加 stop_loss_price 字段
✅ BaseStrategy 传递止损价格到 OrderManager
✅ OrderManager 在创建 Order 对象时保存 stop_loss_price
✅ 市价单跳过资金检查机制
✅ 日志显示正确，不再有 "未提供止损价格" 警告

---

**报告生成时间**: 2026年1月22日
**项目版本**: Athena OS v3.1
**最后更新**: 止损价格传递丢失与平仓资金死锁问题修复（2026-01-22）
